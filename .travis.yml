install:
- wget https://releases.hashicorp.com/terraform/"$TF_VERSION"/terraform_"$TF_VERSION"_linux_amd64.zip
- unzip terraform_"$TF_VERSION"_linux_amd64.zip
- sudo mv terraform /usr/local/bin/
- rm terraform_"$TF_VERSION"_linux_amd64.zip
- terraform init

before_deploy:
- terraform apply -var prefix="" -var location="uk south" -var client_id="7b45e6f82314a24eae60" -var client_secret="be07d5d4c655bf1d6765b061d3f32358aa560042" -auto-approve

# notes From variables.tf
#variable "prefix" default = ""  
#variable "location"   default = "uk south"   
#variable "client_id"   default = "7b45e6f82314a24eae60"
#variable "client_secret" default = "be07d5d4c655bf1d6765b061d3f32358aa560042"


script:

- FLASK_APP=todo_app/app
- FLASK_ENV=development
- docker build --target test --tag todoapptest .
- docker run -p 5000:5000 todoapptest
- docker build --target production -f Dockerfile --tag $DOCKERHUB_USERNAME/todoapp .
- echo $dockerhub_password | docker login --username $DOCKERHUB_USERNAME --password-stdin
- echo "Now for the push"
- echo "-------------------"
- docker push $DOCKERHUB_USERNAME/todoapp

# module 8 Part 3:  Continous deployment

- docker pull britboy4321/todoapp      #  Ensure that we have latest version (possibly not required)
- docker tag britboy4321/todoapp registry.heroku.com/todoappbritboy/web  # Tag it ready for Heroku
- docker login --username=drawlinson48@gmail.com --password=$Heroku_finalpass2 registry.heroku.com
- docker push registry.heroku.com/todoappbritboy/web   # put it onto Heroku

- echo "CONTINUOUS DEPLOYMENT SETUP COMPLETED NOW"
- echo "-----------------------------------------"
# ---
- echo "TIME FOR ACTUAL DEPLOY and RELEASE NOW.."
- echo "----------------------------------------"

deploy:
  provider: script
  script: bash scripts/deploy.sh

    # Very end of module 12
    curl -dH -X POST "$(terraform output -raw extra_variable)"
    #heroku container:release web --app todoappbritboy
    # curl -dH -X POST $azurewebhook
    # bash ./scripts/deploy.sh
    #  curl -dH -X POST "https://\$todobritboywebsite:C2SjFXndkSPHs4n8aBTYpuh5kEFHGbWXBvlaCjMzoiH08CY6D34K7WvhpKFi@todobritboywebsite.scm.azurewebsites.net/docker/hook"
  on: 
    branch:
    - master
    - Module10
    - module10
    - Module11
    - module11
    - Module12
    - module12
    - Module13
    - module13
    - Module14
    - module14
    - Module15
    - module15