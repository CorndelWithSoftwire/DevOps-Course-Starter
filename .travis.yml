env:
  global:
  # Mongo 
    - MONGO_CONN: "mongodb+srv://rajrahman:NWyZIpz9kFnOW4dn@corndel.gyf3r.mongodb.net/test?w=majority"
    - MONGO_DB_NAME: DevOps
    - MONGO_LIST_TODO: todo
    - MONGO_LIST_INPROGRESS: inprogress
    - MONGO_LIST_DONE: done
  # Docker
    - secure: "xxUmhWPB0MLv7DrKeLrt7Q5eNOjSFOL1phnaLLdmvipKBz12eCzgRiAhCmXWroMe4diIaodvcgKgc32kMwiNXaAVGuSOdTs04vRPB5YyGJSQn0BcFuVfBHH+ZPdtLDHzMB/toC1Nk/vF9cUGPvBPA1wDlxbFuEP7ARFUzdfhANIttNB2PVpWOAEWRBFceCpmcKzonhyRKCHZUO1rn64hzTMHJJbPKrpeDDrlJKwIlCSL3JzmuLxZ7cAGoLwQ2irAat6ZX+o+E4L042/+/AFmmlW9AouGHhEACqL9HhzZ1Z7p7SDYV3c6yXQ75j/HpW5RtaJWywEO1aX7Kk0q9mcWjH/X+rlPhtIaUmxFhQyrw9wW6KphQSxIDUYD6bivEWtdwGxPSYQWeO0GczXDv8/dw+mtz8i0/MfsGzUXadmy8F/zvhxSMx5WwaKvleBzLpbuKxXO4BCxcpgXofECByqTdi00NogwEaQOgm+0YU90cl0bvDEqqGP/kDqsR0Q0ZPBiK3+ckrnJrqMnPYCo3eBDKaVVT6PWDSACfVo0xdTxmS0KJWVnAXsYBz8hOr8v0nkiTD3GL/fUZe1wNQO+3T1oRPeYB+Lj7A/WzMcGCBomcyzeW3a4oxCaiRAA4MMS5QFIX9K5NWvSage9NzCJux2dFDU9UgPj8Dylby94Fu4wlBY="
    - secure: "J61/KUCNGuWiZ6kiZDMjcKWFXGfnluE2+umVV8zgKX0MmGMv5ZyB1QIBNgQi72UUZSrvCUFh+lf77t7SgdHVM2hrsAITgFraFIl3Cyd3nfSoyoI2g7clhtar3rOovyg+hmScVDy96xeIgbT+DOzdEqKw5AEanQO9wZxI+X6jUcqOJsj8dTVPJwaNOfQ/416qQxGQXKQMyBRn9N6e/Im0UmpfifqYLvnWK5+ELhxuFNs7ZZd/nzQRgA97u9ytDzHC1SIIK2LPLgn64IaiBdau8jWqD2PiveYlKzLEAu7aiDkLF7KUcOkh8Q3UUbf0sJt3IO0TJRUe0hdvcbpHpgHHQlTdKUuTVijpN9spdWobuLIp1QUug+zv1vlFUvypt1wR80wmiv9xFPYHrOvV7hTksNReo6yDeIE2H/YSLQSSKJaWfvT9vXDxMj4aNb3UVWp0FTdmd4d0xFG94pxYImXI/ZyzFqPES33MDDSC8ffIJfyX9MmNsEl3e6PaeWrgulp4Nkhene25R+kLrosqw+cTPoc92Hctm6zndrbUVeiywBPbRjXiEWakJ2MDzAqzd4GP/1tuxIL1YY8MOpKw4SNV19Ke1ywy59iRAb8GY4nj66aQOgErOdkGla8s69KJrr221rh4PusisYDRrirMev4MS0b68snxNjcN0FEk+IBvlL4="
  # Heroku
    - herokuapp: rajrahmantodoapp
    - secure: "u9PjQ6s5qpMRnQZVbHaQ3u/9JmI2ooMafJoLaFTeb7+b14x169/dxsvH+58iFLiqjQgyG3eoM539CwLOQ3PkeE3VFmSysQ4Sw2B9tqE9ee763Pb+mSnTceZ6l3/OAvJmb3ZO9P1p0GG5pTDBSl9PdXZQBYoN8Tcx6OrXR1pAMAmbme1BYuuvqeX+TQvj5gK7kdXK7IINKbRcIO6QmO4h/w4Bhh9q/p2iLsEqjoXWHVWpAaz4H/YWQTs5rT3/zaI1NzXf6vXYZikdr2c4Hlyhnv1q+P052r2hr9DKoI/qKQbY8Wd8/9dtmiCTpyzGz2MSh4wIxNYUcxQ8clzIasGmUfLTPJiL0Rbu9soly5/mAV73na2g6vRO12Hng4MlR4C1pfAk541Vx1pll5+9/HSu3Bw4tyngOc1y0knn6H7HWPz3CfuPAz45PaZCn9QI+Zt0/5jlBeXC5Ez6kV2n4Sywt3hDevZP2lbq4Q0dtQGd6au0u+Os3TMq+jTg13Cj/u9Zbyoce5ywZA1W8EXqtSNu7MCvSD0bcbIn4HOFA85m5Qjbblg5NkxbW+xA3lrH/BhkW/B1d1ifVxTV4reuaNlR9q+KYEI8I9ZvOxnZgfenl5IjplXx4ayTVXny9JaM0vJTjQ2XPzxYlkwuFdAIpN3gq8F5FmlajDsULfpDTCBhxxY="
    - secure: "gOWWEMWMUnNWJmwH25wEzjcbOMhA6E/WHyNoI1QclNZFrHtUhhZXYO53lTWtAgvRZf9D0ouPmwAcE7Hgbjh/ql3ERWpsU8W0XiolCopd5zMfYp4gpxiQVdiYTyEW8WYv8mrtwQ/lHzWSij58MAsgBDML/IYdgHHvl7Ty8b2tGE3dUd+wrLsE8nZ3XohyUELnqfNAC5+qPOv3vWSL3cAVOSSAkWsrsowbpnbprpNmV18HO0dZZno3cGj3Sj9KOUTE6ceS1TSyz9oyzyZ3zp63IUkISGS6hOcMmQEU1toixO80tQG447mkRYAZlsXo6z3rjYNNvxVZsmKFxreYeBZGbOJeiW7fI8ZBin2fhuRoERYP84psB1IFEvOuBGyrHZiScZgmFPF0r75pp8we7w/3fBQq35luCnL5hJQ13V28JFDyHYUPAm5+alzUIA2hOBjYBtGVhSSevLlpQrLUdGmxqZFWumo2qXXWxsabsbwWG4oK3ixCJP1ET0rkls5BmLr1MjWLJN30miekP54O/gk23yWH0XviAbs8MOUY+Mel6TiwEF2N1X7UdjfMSrcnKknv78dfvoAFByqlT54oiZv6yzpb7cyFuQfqRWBiMDKulu6u819F5UQzE7Z+rVOQnXglPkrwuJu8ky8Lrsdd2Lfrbc6Zaz3w5+Tcixux1jbVvhQ="

services:
  - docker

before_script:
  - curl https://cli-assets.heroku.com/install.sh | sh
  - docker login --username $docker_login --password $docker_password

script:

  # Docker TEST Build the Image
  - docker build --target test --tag todoapp:test .

  # Docker Run Unit Test
  - echo "Running Unit Tests"
  - docker run todoapp:test test_view_model.py

  # Docker Run Integration tests 
  - echo "Running Integration Tests"
  #- docker run todoapp:test test_todoapp.py

  # Docker Run E2E 
  - echo "Running E2E Tests"
  - docker run -e MONGO_DB_NAME=$MONGO_DB_NAME -e MONGO_CONN=$MONGO_CONN -e MONGO_LIST_TODO=$MONGO_LIST_TODO -e MONGO_LIST_INPROGRESS=$MONGO_LIST_INPROGRESS -e MONGO_LIST_DONE=$MONGO_LIST_DONE todoapp:test test_mongo.py

  # Docker PRODUCTION Build and Push 
  - docker build --target production --tag $docker_login/todoapp:latest .
  - docker push $docker_login/todoapp:latest

  # Docker Pull latest image & Tag
  - echo "Pull image from Dockerhub and Tag"
  - docker pull $docker_login/todoapp:latest     
  - docker tag $docker_login/todoapp:latest registry.heroku.com/rajrahmantodoapp/web

  # Login to Heroku
  - echo "Login to Heroku"
  - echo $HEROKU_API_KEY | docker login --username=$heroku_login --password-stdin registry.heroku.com

  # Push image to Heroku
  - echo "Push image to Heroku"
  - docker push registry.heroku.com/rajrahmantodoapp/web

# Release image in Heroku
deploy:
  provider: script
  script: heroku container:release web --app rajrahmantodoapp
  on:
      all_branches: true
